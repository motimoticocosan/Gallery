name: Resize & Compress Images (No WebP)

on:
  push:
    paths:
      - 'images/**'
    branches:
      - main

jobs:
  optimize:
    runs-on: ubuntu-latest

    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v3

      - name: ImageMagickとoptipngをインストール
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick optipng

      - name: 画像のリサイズと圧縮処理
        run: |
          # 長辺が2500pxを超える画像を縮小（縦横比は維持）
          find images -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) | while read file; do
            WIDTH=$(identify -format "%w" "$file")
            HEIGHT=$(identify -format "%h" "$file")
            LONGEST=$(($WIDTH > $HEIGHT ? $WIDTH : $HEIGHT))
            if [ "$LONGEST" -gt 2500 ]; then
              echo "Resizing: $file"
              mogrify -resize 2500x2500\> "$file"
            fi
          done

          # JPEG圧縮
          find images -type f \( -iname "*.jpg" -o -iname "*.jpeg" \) -exec mogrify -strip -quality 85% {} +

          # PNG圧縮（無損失）
          find images -type f -iname "*.png" -exec optipng -o7 {} \;

      - name: 圧縮後のファイルをコミット & プッシュ
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add images
          git commit -m "Auto-resized and compressed images"
          git push
        continue-on-error: true
